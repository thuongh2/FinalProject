{% extends "layout.html" %} {% block title %}Dự đoán giá nông sản{% endblock %}
{% block header %}{% endblock %} {% block content %}

<!-- Begin Page Content -->
<!-- Slide image -->
<div class="row" style="height: 450px">
  <div class="slide-container col-xl-12">
    <div class="slide-wrap">
      <div class="slide-image col-xl-12 bg-slide-image1" style="height: 450px">
        <a href="#container-fluid" class="text-overlay">Dự đoán giá nông sản</a>
      </div>
      <div class="slide-image col-xl-12 bg-slide-image2" style="height: 450px">
        <a href="#container-fluid" class="text-overlay">Dự đoán giá nông sản</a>
      </div>
      <div class="slide-image col-xl-12 bg-slide-image3" style="height: 450px">
        <a href="#container-fluid" class="text-overlay">Dự đoán giá nông sản</a>
      </div>
    </div>
  </div>
</div>

<!-- <iframe src="/streamlit" width="100%" height="800"></iframe> -->

<div id="container-fluid" class="container-fluid mt-2" style="padding: 0">
  <div class="row shadow" style="padding: 0">
    <!-- Card 1 -->
    <a id="coffee" href="#coffee" class="col-xl-4 price-agricutural active">
      <div class="card-price h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="h5 font-weight-bold text-primary text-uppercase mb-1">
                Giá cà phê
              </div>
              <div class="h5 mb-0 font-weight-bold text-primary text-gray-800">
                Hôm nay: 10.000đ
              </div>
            </div>
            <div class="col-auto">
              <i
                class="fas fa-arrow-trend-up text-success"
                style="font-size: 1.5em"
              ></i>
            </div>
          </div>
        </div>
      </div>
    </a>
    <!-- Card 2 -->
    <a id="rice" href="#rice" class="col-xl-4 price-agricutural">
      <div class="card-price h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="h5 font-weight-bold text-primary text-uppercase mb-1">
                Giá lúa
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                Hôm nay: 10.000đ
              </div>
            </div>
            <div class="col-auto">
              <i
                class="fas fa-arrow-trend-up text-success"
                style="font-size: 1.5em"
              ></i>
            </div>
          </div>
        </div>
      </div>
    </a>
    <!-- Card 3 -->
    <a id="watermelon" href="#watermelon" class="col-xl-4 price-agricutural">
      <div class="card-price h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="h5 font-weight-bold text-primary text-uppercase mb-1">
                Giá dưa hấu
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                Hôm nay: 10.000đ
              </div>
            </div>
            <div class="col-auto">
              <i
                class="fas fa-arrow-trend-down text-danger"
                style="font-size: 1.5em"
              ></i>
            </div>
          </div>
        </div>
      </div>
    </a>
  </div>
</div>
<!-- Content Row -->

<div class="row">
  <!-- Area Chart -->
  <div class="col-xl-9 mt-4">
    <div class="card shadow mb-4">
      <!-- Card Header - Dropdown -->
      <div
        class="card-header py-3 d-flex flex-row align-items-center justify-content-between"
      >
        <h5 class="m-0 font-weight-bold text-primary">
          Biểu đồ dự đoán giá nông sản
        </h5>
      </div>
      <!-- Card Body -->
      <div class="card-body">
        <div id="charts-container" style="height: 100%;">
          <div id="myDiv" style="height: 100%"></div>
        </div>
      </div>
    </div>
  </div>
    <!-- Select area -->
    <div class="col-xl-3 card shadow mt-4" style="height: 547px">
      <div class="col-xl-12 mt-4">
        <div
          class="h4 font-weight-bold text-uppercase text-gray-800 mb-1"
          style="text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.1)"
        >
          Giá cà phê 5/5/2024: <strong>100.000đ</strong>
        </div>
        <div
          class="h4 mt-2 mb-0 font-weight-bold text-warning"
          style="text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.1)"
        >
          Giá dự đoán: 100.000đ
        </div>
        <div class="pt-4"></div>
        <!-- Chọn mô hình -->
        <div class="mt-4">
          <select id="model_name" class="form-control form-select col-xl-12" style="color: black">
            {% for model in models %}
              {% if model.name == 'GRU' %}
                <option value="{{model.name}}" selected>{{model.name}}</option> 
              {% else %}
                <option value="{{model.name}}">{{model.name}}</option>
              {% endif %}
            {% endfor %}
          </select>        
        </div>
        
        <!-- Chọn dữ liệu -->
        <div class="mt-4">
          <select id="data_name" name="data_name" class="form-control form-select col-xl-12" style="color: black">
            <option></option>
            {% for item in data.data %}
            <option value="{{ item }}">{{ item['name'] }}</option>
            {% endfor %}
          </select>        
        </div>

        <!-- Chọn thời gian -->
        <div class="mt-4">
          <select
            id="time-select"
            class="form-control form-select col-xl-12"
            style="color: black"
          >
            <option value="30days" selected>30 ngày</option>
            <option value="60days">60 ngày</option>
          </select>
        </div>
      </div>
    </div>  
  </div>

  <!-- Content Row -->
  <div class="row">
    <!-- Content Column -->
    <div class="col-lg-6 mb-4 mt-4">
      <div class="card shadow mb-4">
        <div class="card-header py-3">
          <h5 class="m-0 font-weight-bold text-primary">Bảng giá nông sản</h5>
        </div>
        <div class="card-body">
          <div class="custom-scroll" style="height: 400px; overflow-y: scroll">
            <table
              class="table table-bordered dataTable"
              id="priceDataTable"
              width="100%"
              cellspacing="0"
              role="grid"
              aria-describedby="dataTable_info"
            >
              <thead
                style="
                  background-color: rgb(247, 246, 246);
                  position: sticky;
                  top: -2px;
                  z-index: 1;
                "
              >
                <tr role="row">
                  <th
                    class="sorting sorting_asc"
                    tabindex="0"
                    aria-controls="dataTable"
                    rowspan="1"
                    colspan="1"
                    aria-sort="ascending"
                    aria-label="Name: activate to sort column descending"
                    style="width: 160px; background-color: rgb(247, 246, 246)"
                  >
                    <strong>Ngày</strong>
                  </th>
                  <th
                    class="sorting"
                    tabindex="0"
                    aria-controls="dataTable"
                    rowspan="1"
                    colspan="1"
                    aria-label="Position: activate to sort column ascending"
                    style="width: 246px; background-color: rgb(247, 246, 246)"
                  >
                    <strong>Giá</strong>
                  </th>
                  <th
                    class="sorting"
                    tabindex="0"
                    aria-controls="dataTable"
                    rowspan="1"
                    colspan="1"
                    aria-label="Position: activate to sort column ascending"
                    style="width: 246px; background-color: rgb(247, 246, 246)"
                  >
                    <strong>Loại Nông sản</strong>
                  </th>
                </tr>
              </thead>

              <tbody>
                {% for data in price_data %}
                <tr
                  style="font-weight: normal"
                  onmouseover="this.style.fontWeight='bold';"
                  onmouseout="this.style.fontWeight='normal';"
                >
                  <td>{{ data.date }}</td>
                  <td>{{ data.price }}</td>
                  <td>{{ data.algricutural_name }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6 mb-4 mt-4">
      <div class="card shadow mb-4">
        <!-- Card Header - Dropdown -->
        <div
          class="card-header py-3 d-flex flex-row align-items-center justify-content-between"
        >
          <h5 class="m-0 font-weight-bold text-primary">
            Top mô hình có độ chính xác cao
          </h5>
        </div>
        <!-- Card Body -->
        <div class="card-body">
          <table
            class="table table-bordered dataTable"
            id="dataTable"
            width="100%"
            cellspacing="0"
            role="grid"
            aria-describedby="dataTable_info"
            style="width: 100%"
          >
            <thead>
              <tr role="row">
                <th
                  class="sorting sorting_asc"
                  tabindex="0"
                  aria-controls="dataTable"
                  rowspan="1"
                  colspan="1"
                  aria-sort="ascending"
                  aria-label="Name: activate to sort column descending"
                  style="width: 160px"
                >
                  Tên
                </th>
                <th
                  class="sorting"
                  tabindex="0"
                  aria-controls="dataTable"
                  rowspan="1"
                  colspan="1"
                  aria-label="Position: activate to sort column ascending"
                  style="width: 246px"
                >
                  Đánh giá
                </th>
              </tr>
            </thead>
            <tbody>
              <tr class="odd">
                <td class="sorting_1">hoaithuong.data@gmail.com</td>
                <td>RMSE: 500</td>
              </tr>

              <tr class="even"></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- /.container-fluid -->

  <!-- Javascript -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
  <script>
    document
      .getElementById("model-select")
      .addEventListener("change", updateCharts);
    document
      .getElementById("time-select")
      .addEventListener("change", updateCharts);

    function updateCharts() {
      var selectedModel = document.getElementById("model-select").value;
      var selectedTime = document.getElementById("time-select").value;

      if (selectedTime === "") {
        selectedModel = "LSTM";
      }

      var charts = document.querySelectorAll(".chart-area");
      charts.forEach(function (chart) {
        chart.style.opacity = "0";
        chart.style.position = "absolute";
      });

      var selectedChart = document.getElementById(
        selectedModel + "-" + selectedTime + "-univariate-coffee"
      );
      if (selectedChart) {
        selectedChart.style.opacity = "1";
        selectedChart.style.position = "relative";
      }
    }
  </script>

  <!-- Active card, hiển thị dữ liệu tương úng-->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      let activeId = "coffee";

      document.querySelector("#coffee .card-price").classList.add("active");

      document.querySelectorAll(".price-agricutural").forEach((item) => {
        item.addEventListener("click", (event) => {
          activeId = event.currentTarget.id;

          document
            .querySelectorAll(".price-agricutural .card-price")
            .forEach((card) => {
              card.classList.remove("active");
            });

          event.currentTarget
            .querySelector(".card-price")
            .classList.add("active");

          showPriceData(activeId);
        });
      });

      function showPriceData(activeId) {
        const rows = document.querySelectorAll("#priceDataTable tbody tr");

        rows.forEach((row) => {
          const agriculturalName =
            row.querySelector("td:nth-child(3)").textContent;

          if (
            (activeId === "coffee" && agriculturalName === "CAFE") ||
            (activeId === "rice" && agriculturalName === "LUA")
          ) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        });
      }

      showPriceData(activeId);
    });
  </script>

  <!-- Croll dữ liệu -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const table = document.getElementById("priceDataTable");
      const scrollbar = document.getElementById("scrollbar");

      scrollbar.addEventListener("scroll", function () {
        table.style.transform = `translateY(-${scrollbar.scrollTop}px)`;
      });

      function updateScrollbarHeight() {
        const totalHeight = table.clientHeight;
        const visibleHeight = scrollbar.clientHeight;
        const scrollHeight = (visibleHeight / totalHeight) * visibleHeight;
        scrollbar.style.height = `${scrollHeight}px`;
      }

      updateScrollbarHeight();

      window.addEventListener("resize", updateScrollbarHeight);
    });
  </script>

  <!-- Load model và tập dữ liệu -->
  <script>
    $(document).ready(function () {
      loadDataForInitialModel();

      $("#model_name").change(loadDataForInitialModel);

      function loadDataForInitialModel() {
        var selectedModel = $("#model_name").val();

        $.ajax({
          url: "/search-one-model",
          method: "GET",
          data: { model_name: selectedModel },
          success: function (response) {
            var options = response.data
              .map(function (dataItem) {
                return (
                  '<option value="' +
                  dataItem.type +
                  '">' +
                  dataItem.name +
                  "</option>"
                );
              })
              .join("");
            $("#data_name").html(options);

            var activeId = $(".price-agricutural .card-price.active")
              .parent()
              .attr("id");
          },
          error: function (xhr, status, error) {
            console.error("Lỗi:", error);
          },
        });
      }
    });

    document.addEventListener("DOMContentLoaded", function () {
      $("#model_name").val("LSTM");
      $("#model_name").change();
    });

    document.addEventListener("DOMContentLoaded", function () {
      const selectedValue = $("#data_name").val();
      callPlotChart(selectedValue);
    });

    function plotChart(data) {
      $("#myDiv").empty();

      var traces = [];
      var minY = Infinity;
      var maxY = -Infinity;

      data.forEach((value, index) => {
        xDim = new Array();
        for (i in value.x) xDim.push(new Date(value.x[i]));
        yDim = value.y;
        mode = value.mode;
        name = value.name;
        var lineColor, fillColor, fillOpacity;

        if (index === 0) {
          lineColor = 'rgba(0, 110, 255, 0.7)'; 
          fillColor = 'rgba(173, 216, 230, 0.7)'; 
          fillOpacity = 1; 
        } else if (index === 1) {
          lineColor = 'rgba(250,128,114,0.8)';
          fillColor = 'rgba(240,230,140,0.4)'; 
          fillOpacity = 1; 
        }

        minY = Math.min(minY, Math.min(...yDim));
        maxY = Math.max(maxY, Math.max(...yDim));

        var trace = { 
          x: xDim, 
          y: yDim, 
          type: "scatter", 
          mode: mode, 
          name: name,
          line: {color: lineColor}, 
          fill: 'tozeroy', 
          fillcolor: fillColor, 
          visible: true, 
          opacity: fillOpacity,
        };
        traces.push(trace);
      });

      var layout = {
        title:{
          'text': "BIỂU ĐỒ DỰ ĐOÁN",
          'font': {
                'family': 'Arial',
                'size': 20,
                'weight': 'bold'}, 
        },
        xaxis: {                    
          type: 'date',
          title:'Ngày',
          showgrid: false
        },
        yaxis: {
          title: "Giá (đồng)",
          showgrid: false,
          range: [minY * 0.98, maxY * 1.02]
        },
      };

      Plotly.newPlot("myDiv", traces, layout);
    }

    function loadData(state) {
      if (state) {
        $("#plotChart").addClass("d-none");
      } else {
        $("#plotChart").removeClass("d-none");
      }
    }

    async function callPlotChart(data) {
      await loadData(true);
      // const seasonal =
      //   parseInt($("#callPlotChart").find(":selected").text()) || 1;

      const url = "http://localhost:5000/load-chart";
      const modelName = "LSTM";
      const modelData =
        "https://raw.githubusercontent.com/thuongh2/FinalProject/main/data/coffee_daklak.csv";

      const params = {
        model_name: modelName,
        model_data: modelData,
      };

      const queryString = $.param(params);
      const fullUrl = url + "?" + queryString;

      await $.ajax({
        url: fullUrl,
        type: "GET",
        contentType: "application/json",
        success: function (response) {
          plotChart(response.plot_data);
        },
        error: function (xhr, status, error) {
          console.log(error);
        },
      });
    }

    $(document).ready(function () {
      $("#callPlotChart").change(function () {
        var selectedValue = $(this).val();
        callPlotChart(selectedValue);
      });
    });
  </script>
  {% endblock %}
</div>